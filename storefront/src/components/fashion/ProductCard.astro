---
import type { Product } from "../../types/api";

interface Props {
    product: Product;
}

const { product } = Astro.props;

// Helper to format currency (IDR)
const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
    }).format(amount);
};

import { getPlaceholderImage } from "../../lib/utils";

// Fallback image if backend doesn't serve it yet
const imagePath = product.product_image || product.image;
const imageUrl = imagePath
    ? `http://localhost:8080/public/${imagePath}`
    : getPlaceholderImage(product.product_name);
---

<div
    class="group relative bg-white border border-gray-200 rounded-lg flex flex-col overflow-hidden hover:shadow-lg transition-shadow duration-200"
>
    <div
        class="aspect-w-3 aspect-h-4 bg-gray-200 group-hover:opacity-75 sm:aspect-none sm:h-96"
    >
        <img
            src={imageUrl}
            alt={product.product_name}
            class="w-full h-full object-center object-cover sm:w-full sm:h-full"
            loading="lazy"
            onerror={`this.src='${getPlaceholderImage("No Image")}'`}
        />
    </div>
    <div class="flex-1 p-4 space-y-2 flex flex-col">
        <h3 class="text-sm font-medium text-gray-900">
            <a href={`/products/${product.id}`}>
                <span aria-hidden="true" class="absolute inset-0"></span>
                {product.product_name}
            </a>
        </h3>
        <p class="text-sm text-gray-500">{product.category_name}</p>
        <div class="flex-1 flex flex-col justify-end">
            {
                product.sale_price !== product.reguler_price ? (
                    <div class="flex items-center space-x-2">
                        <p class="text-sm font-medium text-gray-900">
                            {formatCurrency(product.sale_price)}
                        </p>
                        <p class="text-sm font-medium text-gray-500 line-through">
                            {formatCurrency(product.reguler_price)}
                        </p>
                    </div>
                ) : (
                    <p class="text-base font-medium text-gray-900">
                        {formatCurrency(product.reguler_price)}
                    </p>
                )
            }
        </div>
    </div>
    <div class="p-4 pt-0">
        <button
            class="add-to-cart-btn w-full bg-indigo-600 border border-transparent rounded-md py-2 px-4 flex items-center justify-center text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 relative z-10"
            data-id={product.id}
            data-name={product.product_name}
            data-price={product.sale_price || product.reguler_price}
            data-image={product.product_image || product.image || ""}
        >
            Add to Cart
        </button>
    </div>
</div>

<script>
    import { addToCart } from "../../lib/store";
    import { getPlaceholderImage } from "../../lib/utils";

    const addToCartButtons = document.querySelectorAll(".add-to-cart-btn");

    addToCartButtons.forEach((button) => {
        button.addEventListener("click", () => {
            // Retrieve data attributes
            const id = button.getAttribute("data-id");
            const name = button.getAttribute("data-name");
            const price = button.getAttribute("data-price");
            const image = button.getAttribute("data-image"); // Optional

            if (id && name && price) {
                addToCart({
                    product_id: parseInt(id),
                    quantity: 1,
                    size: "Standard", // Default
                    color: "Standard", // Default
                    product: {
                        id: parseInt(id),
                        product_name: name,
                        sale_price: parseInt(price),
                        reguler_price: parseInt(price), // Simplified
                        category_name: "Fashion",
                        product_image: image || undefined,
                    },
                });

                // Visual feedback (optional)
                const originalText = button.innerText;
                button.innerText = "Added!";
                setTimeout(() => (button.innerText = originalText), 1000);
            }
        });
    });
</script>
