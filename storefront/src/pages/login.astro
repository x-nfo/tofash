---
import BaseLayout from "../layouts/BaseLayout.astro";
import { api } from "../lib/api";
import { setUser } from "../lib/store";
import type { User, ApiResponse } from "../types/api";

let error = "";
let success = "";
---

<BaseLayout title="Sign In">
    <div class="min-h-full flex flex-col justify-center py-12 sm:px-6 lg:px-8">
        <div class="sm:mx-auto sm:w-full sm:max-w-md">
            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                Sign in to your account
            </h2>
            <p class="mt-2 text-center text-sm text-gray-600">
                Or
                <a
                    href="/register"
                    class="font-medium text-indigo-600 hover:text-indigo-500"
                >
                    create a new account
                </a>
            </p>
        </div>

        <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
            <div class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
                {
                    error && (
                        <div class="mb-4 bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded relative">
                            {error}
                        </div>
                    )
                }
                {
                    success && (
                        <div
                            id="success-message"
                            class="mb-4 bg-green-50 border border-green-200 text-green-600 px-4 py-3 rounded relative"
                            data-user={JSON.stringify(Astro.locals)}
                        >
                            {success}
                        </div>
                    )
                }

                <form
                    class="space-y-6"
                    action="/login"
                    method="POST"
                    id="login-form"
                >
                    <div>
                        <label
                            for="email"
                            class="block text-sm font-medium text-gray-700"
                        >
                            Email address
                        </label>
                        <div class="mt-1">
                            <input
                                id="email"
                                name="email"
                                type="email"
                                autocomplete="email"
                                required
                                class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            />
                        </div>
                    </div>

                    <div>
                        <label
                            for="password"
                            class="block text-sm font-medium text-gray-700"
                        >
                            Password
                        </label>
                        <div class="mt-1">
                            <input
                                id="password"
                                name="password"
                                type="password"
                                autocomplete="current-password"
                                required
                                class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            />
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input
                                id="remember-me"
                                name="remember-me"
                                type="checkbox"
                                class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                            />
                            <label
                                for="remember-me"
                                class="ml-2 block text-sm text-gray-900"
                            >
                                Remember me
                            </label>
                        </div>

                        <div class="text-sm">
                            <a
                                href="#"
                                class="font-medium text-indigo-600 hover:text-indigo-500"
                            >
                                Forgot your password?
                            </a>
                        </div>
                    </div>

                    <div>
                        <button
                            type="submit"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                        >
                            Sign in
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</BaseLayout>

<script>
    // Client-side login handling with smart API fetcher
    import { api } from "../lib/api";
    import { setUser } from "../lib/store";
    import type { User } from "../types/api";

    const form = document.getElementById("login-form") as HTMLFormElement;

    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData(form);
            const email = formData.get("email") as string;
            const password = formData.get("password") as string;

            // Disable submit button
            const submitBtn = form.querySelector(
                'button[type="submit"]',
            ) as HTMLButtonElement;
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = "Signing in...";

            try {
                // Use smart API fetcher (client-side mode)
                const response = await api<User>("/login", {
                    method: "POST",
                    body: { email, password },
                    auth: false, // Login doesn't require auth
                });

                if (response.data) {
                    // Debug: Log the response to see what we're getting
                    console.log("Login response:", response.data);
                    console.log("Role name:", response.data.role_name);
                    console.log("Role:", response.data.role);

                    // 1. Update Nano Store
                    setUser(response.data);

                    // 2. SET COOKIES (Crucial for Middleware and SSR)
                    // Expires in 1 day (86400 seconds)
                    document.cookie = `access_token=${response.data.access_token}; path=/; max-age=86400; SameSite=Lax`;
                    document.cookie = `user_role=${response.data.role_name || response.data.role}; path=/; max-age=86400; SameSite=Lax`;

                    // 3. Redirect based on role
                    const role = response.data.role_name || response.data.role;

                    // Check for admin roles (case-insensitive)
                    if (role && role.toLowerCase().includes("admin")) {
                        window.location.href = "/admin";
                    } else {
                        window.location.href = "/";
                    }
                } else {
                    alert(response.message || "Login failed");
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            } catch (err: any) {
                console.error("Login error:", err);
                alert(err.message || "Login error. Please try again.");
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
    }
</script>
