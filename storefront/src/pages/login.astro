---
import BaseLayout from "../layouts/BaseLayout.astro";
import { api } from "../lib/api";
import { setUser } from "../lib/store";
import type { User, ApiResponse } from "../types/api";

let error = "";
let success = "";
---

<BaseLayout title="Sign In">
    <div class="min-h-full flex flex-col justify-center py-12 sm:px-6 lg:px-8">
        <div class="sm:mx-auto sm:w-full sm:max-w-md">
            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                Sign in to your account
            </h2>
            <p class="mt-2 text-center text-sm text-gray-600">
                Or
                <a
                    href="/register"
                    class="font-medium text-indigo-600 hover:text-indigo-500"
                >
                    create a new account
                </a>
            </p>
        </div>

        <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
            <div class="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
                {
                    error && (
                        <div class="mb-4 bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded relative">
                            {error}
                        </div>
                    )
                }
                {
                    success && (
                        <div
                            id="success-message"
                            class="mb-4 bg-green-50 border border-green-200 text-green-600 px-4 py-3 rounded relative"
                            data-user={JSON.stringify(Astro.locals)}
                        >
                            {success}
                        </div>
                    )
                }

                <form
                    class="space-y-6"
                    action="/login"
                    method="POST"
                    id="login-form"
                >
                    <div>
                        <label
                            for="email"
                            class="block text-sm font-medium text-gray-700"
                        >
                            Email address
                        </label>
                        <div class="mt-1">
                            <input
                                id="email"
                                name="email"
                                type="email"
                                autocomplete="email"
                                required
                                class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            />
                        </div>
                    </div>

                    <div>
                        <label
                            for="password"
                            class="block text-sm font-medium text-gray-700"
                        >
                            Password
                        </label>
                        <div class="mt-1">
                            <input
                                id="password"
                                name="password"
                                type="password"
                                autocomplete="current-password"
                                required
                                class="appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                            />
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <input
                                id="remember-me"
                                name="remember-me"
                                type="checkbox"
                                class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                            />
                            <label
                                for="remember-me"
                                class="ml-2 block text-sm text-gray-900"
                            >
                                Remember me
                            </label>
                        </div>

                        <div class="text-sm">
                            <a
                                href="#"
                                class="font-medium text-indigo-600 hover:text-indigo-500"
                            >
                                Forgot your password?
                            </a>
                        </div>
                    </div>

                    <div>
                        <button
                            type="submit"
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                        >
                            Sign in
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</BaseLayout>

<script>
    // Client-side handling for success redirect and store update
    // We intercept the form submission to capture the response more easily if we wanted AJAX,
    // but since we used standard form post, we need a way to pass data to client.

    // Better approach for SPA-feel: Use client-side fetch.
    import { api } from "../lib/api";
    import { setUser } from "../lib/store";
    import type { User } from "../types/api";

    const form = document.getElementById("login-form") as HTMLFormElement;
    const errorDiv = document.querySelector(".text-red-600"); // Simple selector

    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const email = formData.get("email") as string;
            const password = formData.get("password") as string;

            try {
                const response = await api<User>("/login", {
                    method: "POST",
                    body: { email, password },
                    auth: false,
                });

                if (response.status && response.data) {
                    // Update global store
                    setUser(response.data);

                    // Set Cookies
                    document.cookie = `access_token=${response.data.access_token}; path=/; max-age=86400; SameSite=Strict`;
                    document.cookie = `user_role=${response.data.role_name}; path=/; max-age=86400; SameSite=Strict`;

                    // Redirect
                    window.location.href = "/";
                } else {
                    alert(response.message || "Login failed");
                }
            } catch (err: any) {
                console.error(err);
                alert(err.message || "Login error");
            }
        });
    }
</script>
